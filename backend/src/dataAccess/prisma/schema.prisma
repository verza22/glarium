
generator client {
  provider = "prisma-client-js"
  output   = "generated/client"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}


model User {
  id                 Int    @id @default(autoincrement())
  name               String
  email              String    @unique
  emailVerifiedAt    DateTime?
  password           String
  rememberToken      String?  
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  resources          UserResource[]
  regiments          Regiment[]
  userResearch UserResearch[]
  movements Movement[]
  cities    UserCity[]
}

model PasswordReset {
  id        Int   @id @default(autoincrement())
  email     String
  token     String
  createdAt DateTime?
}

model FailedJob {
  id        Int   @id @default(autoincrement())
  connection String
  queue      String
  payload    String
  exception  String
  failedAt   DateTime @default(now())
}

model City {
  id            Int    @id @default(autoincrement())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  constructedAt DateTime?
  name          String
  wood          Float
  wine          Float
  marble        Float
  glass         Float
  sulfur        Float
  apoint        Int
  cityBuildings CityBuilding[]
  islandCity  IslandCity?
  population    CityPopulation?
  regiments Regiment[]
  movementsFrom Movement[] @relation("CityFrom")
  movementsTo   Movement[] @relation("CityTo")
  donations        IslandDonation[] 
  messagesFrom  Message[] @relation("MessagesFrom")
  messagesTo    Message[] @relation("MessagesTo")
  mayors Mayor[]
  userCities UserCity[]
}

model UserCity {
  id      Int  @id @default(autoincrement())
  userId  Int
  cityId  Int
  capital Boolean

  user User @relation(fields: [userId], references: [id])
  city City @relation(fields: [cityId], references: [id])
}

model Building {
  id    Int @id @default(autoincrement())
  name  String
  image String
  text  String @db.Text
  levels BuildingLevel[]
  researchBuildings ResearchBuilding[]
}

model BuildingLevel {
  id         Int  @id @default(autoincrement())
  buildingId Int
  level      Int
  wood       Int
  wine       Int
  marble     Int
  glass      Int
  sulfur     Int
  time       Int
  cityBuildings CityBuilding[]

  building   Building @relation(fields: [buildingId], references: [id])
}

model CityBuilding {
  id              Int     @id @default(autoincrement())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  deletedAt       DateTime?
  constructedAt   DateTime?
  buildingLevelId Int
  cityId          Int
  position        Int

  buildingLevel   BuildingLevel @relation(fields: [buildingLevelId], references: [id])
  city            City          @relation(fields: [cityId], references: [id])
}

model Forest {
  id      Int @id @default(autoincrement())
  level   Int
  workers Int
  wood    Int
  time    Int
  islands Island[]
}

model Mine {
  id      Int @id @default(autoincrement())
  level   Int
  workers Int
  wood    Int
  time    Int
  islands Island[]
}

model IslandSector {
  id   Int @id @default(autoincrement())
  name String
  islands Island[]
}

model Island {
  id                   Int       @id @default(autoincrement())
  islandSectorId       Int
  x                    Int
  y                    Int
  name                 String
  type                 Int
  forestId             Int
  mineId               Int
  donatedForest        Int
  donatedMine          Int
  forestConstructedAt  DateTime?
  mineConstructedAt    DateTime?
  islandCity         IslandCity[] 
  donations        IslandDonation[] 

  islandSector         IslandSector @relation(fields: [islandSectorId], references: [id])
  forest               Forest       @relation(fields: [forestId], references: [id])
  mine                 Mine         @relation(fields: [mineId], references: [id])
}

model IslandCity {
  id        Int   @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // para soft deletes
  position  Int
  islandId  Int
  cityId    Int @unique

  island    Island @relation(fields: [islandId], references: [id])
  city      City   @relation(fields: [cityId], references: [id])
}

model CityPopulation {
  id Int @id @default(autoincrement())
  cityId Int @unique
  populationMax Int
  population Float
  workerForest Int
  workerMine Int
  wineMax Int
  wine Int
  scientistsMax Int
  scientists Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  city City @relation(fields: [cityId], references: [id])
}

model UserResource {
  id Int @id @default(autoincrement())
  userId Int @unique
  gold Float
  researchPoint Float
  tradeShip Int
  tradeShipAvailable Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Unit {
  id             Int  @id @default(autoincrement())
  name           String  @db.VarChar(25)
  image          String
  text           String  @db.Text
  population     Int
  size           Int
  wood           Int
  wine           Int
  glass          Int
  sulfur         Int
  time           Int
  barrackLevel   Int
  gold           Int
  attack         Int
  attackType     Int
  defenseBlunt   Int
  defenseSharp   Int
  defenseDistance Int
  regimentsUnits RegimentUnit[]
  regimentTails  RegimentTail[]
  researchUnits ResearchUnit[]
  attackDetails      CombatReportDetail[]   @relation("AttackUnit")   // details where the unit attacked
  defenseDetails     CombatReportDetail[]   @relation("DefenseUnit")
}

model Regiment {
  id        Int   @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  userId Int
  cityId Int
  travel Int
  regimentsUnits RegimentUnit[]
  regimentTails  RegimentTail[]
  movementRegiments MovementRegiment[]

  user User @relation(fields: [userId], references: [id])
  city City @relation(fields: [cityId], references: [id])
}

model RegimentUnit {
  id         Int   @id @default(autoincrement())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deletedAt  DateTime?
  regimentId Int
  unitId     Int
  cant       Int

  regiment Regiment @relation(fields: [regimentId], references: [id])
  unit     Unit     @relation(fields: [unitId], references: [id])
}

model RegimentTail {
  id           Int    @id @default(autoincrement())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?
  constructedAt DateTime?
  regimentId   Int
  unitId       Int
  cant         Int
  tail         Int

  regiment Regiment @relation(fields: [regimentId], references: [id])
  unit     Unit     @relation(fields: [unitId], references: [id])
}

model ResearchCategory {
  id   Int  @id @default(autoincrement())
  name String
  research  Research[]
}

model Research {
  id                  Int           @id @default(autoincrement())
  researchCategoryId  Int
  level               Int
  cost                Int
  name                String
  text                String           @db.Text
  userResearch UserResearch[]
  researchUnits ResearchUnit[]
  researchBuildings ResearchBuilding[]

  researchCategory    ResearchCategory @relation(fields: [researchCategoryId], references: [id])
}

model UserResearch {
  id         Int    @id @default(autoincrement())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  userId     Int
  researchId Int

  user       User      @relation(fields: [userId], references: [id])
  research   Research  @relation(fields: [researchId], references: [id])
}

model ResearchUnit {
  id         Int    @id @default(autoincrement())
  unitId     Int
  researchId Int

  unit       Unit      @relation(fields: [unitId], references: [id])
  research   Research  @relation(fields: [researchId], references: [id])
}

model ResearchBuilding {
  id         Int    @id @default(autoincrement())
  buildingId Int
  researchId Int

  building   Building  @relation(fields: [buildingId], references: [id])
  research   Research  @relation(fields: [researchId], references: [id])
}

model MovementType {
  id   Int  @id @default(autoincrement())
  name String
  movements Movement[]
}

model Movement {
  id               Int      @id @default(autoincrement())
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  deletedAt        DateTime?   // soft delete
  startAt          DateTime?
  endAt            DateTime?
  returnAt         DateTime?
  delivered        Boolean
  cancelled        Boolean
  userId           Int
  cityFromId       Int
  cityToId         Int
  movementTypeId   Int
  tradeShip        Int
  resources        MovementResource?
  movementRegiments MovementRegiment[]

  user             User        @relation(fields: [userId], references: [id])
  cityFrom         City        @relation("CityFrom", fields: [cityFromId], references: [id])
  cityTo           City        @relation("CityTo", fields: [cityToId], references: [id])
  movementType     MovementType @relation(fields: [movementTypeId], references: [id])
}

model MovementResource {
  id          Int    @id @default(autoincrement())
  movementId  Int    @unique
  wood        Int
  wine        Int
  marble      Int
  glass       Int
  sulfur      Int

  movement    Movement @relation(fields: [movementId], references: [id])
}

model MovementRegiment {
  id           Int     @id @default(autoincrement())
  movementId   Int
  regimentId   Int
  size         Int
  combatReports CombatReport[]

  movement     Movement   @relation(fields: [movementId], references: [id])
  regiment     Regiment   @relation(fields: [regimentId], references: [id])
}

model CombatReport {
  id                 Int          @id @default(autoincrement())
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  movementRegimentId Int
  result             Int             // 0 = undefined/error, 1 = attacker win, 2 = defender win
  combatReportDetails CombatReportDetail[] 

  movementRegiment   MovementRegiment @relation(fields: [movementRegimentId], references: [id])
}

model CombatReportDetail {
  id                 Int        @id @default(autoincrement())
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  combatReportId     Int
  round              Int
  typeAttack         Int
  result             Int
  attackUnitId       Int
  attackBeforeCant   Int
  attackAfterCant    Int
  defenseUnitId      Int
  defenseBeforeCant  Int
  defenseAfterCant   Int

  combatReport       CombatReport  @relation(fields: [combatReportId], references: [id])
  attackUnit         Unit          @relation("AttackUnit", fields: [attackUnitId], references: [id])
  defenseUnit        Unit          @relation("DefenseUnit", fields: [defenseUnitId], references: [id])
}

model IslandDonation {
  id        Int   @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  islandId  Int
  cityId    Int
  type      Int
  donated   Int

  island    Island @relation(fields: [islandId], references: [id])
  city      City   @relation(fields: [cityId], references: [id])
}

model Message {
  id            Int   @id @default(autoincrement())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAtFrom DateTime?
  deletedAtTo   DateTime?
  cityFromId    Int
  cityToId      Int
  type          Int
  readed        Int
  message       String

  cityFrom      City @relation("MessagesFrom", fields: [cityFromId], references: [id])
  cityTo        City @relation("MessagesTo", fields: [cityToId], references: [id])
}

model Mayor {
  id        Int   @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cityId    Int
  type      Int
  readed    Int
  data      Json

  city      City @relation(fields: [cityId], references: [id])
}